---
title: "Treaty on the Prohibition of Nuclear Weapons"
author: "Spencer Graves"
date: "2020-09-09"
output: html_document
vignette: >
  %\VignetteIndexEntry{Treaty on the Prohibition of Nuclear Weapons}
  %\VignetteKeyword{TPNW}
  %\VignetteEngine{knitr::rmarkdown}
  %\SweaveUTF8
  \usepackage[utf8](inputenc)
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Intro 

I want to predict the date that the [Treaty on the Prohibition of Nuclear Weapons](https://treaties.un.org/Pages/ViewDetails.aspx?src=TREATY&mtdsg_no=XXVI-9&chapter=26&clang=_en) will enter into force.  I plan to do this by scraping the table of Participants from the web page on that treaty from the web site of the [United Nations Treaty Collection](https://treaties.un.org).  

## URL

```{r link}
TPNWurl <- "https://treaties.un.org/Pages/ViewDetails.aspx?src=TREATY&mtdsg_no=XXVI-9&chapter=26&clang=_en"
```

## Scraping 

I don't remember how to do this.  

```{r eval=FALSE}
library(sos)
(scrape <- findFn('scrape web page'))
(scrapeTable <- findFn('extract a table from a web page'))
```

On 2020-07-18 this found 24 links in 11 packages.  The first 3 packages seemed excessively specialized.^[For example, the first package found by `findFn` was [BAwiR](https://www.rdocumentation.org/packages/BAwiR/versions/1.2.4) for "Analysis of Basketball Data".]  The fourth was [rvest](https://www.rdocumentation.org/packages/rvest/versions/0.3.6) to [Easily Harvest (Scrape) Web Pages](http://finzi.psych.upenn.edu/R/library/rvest/html/00Index.html) by Hadley Wickham and others with RStudio.  
CONCERN:  This wants me to use \code{Selectorgadget}.  I'd prefer to try to do this without using that \code{Selectorgadget}.  I remember having worked with that before and not getting it to work for me.    

A web search led me to a 2012-01-15 article on ["Scraping table from any web page with `R` or `CloudStat`"](https://www.r-bloggers.com/scraping-table-from-any-web-page-with-r-or-cloudstat/).  This suggests using [`XML::readHTMLTable`](https://www.rdocumentation.org/packages/XML/versions/3.99-0.2/topics/readHTMLTable).  

```{r eval=FALSE}
library(XML)
TPNWchars <- XML::readHTMLTable(TPNWurl)
length(TPNWchars)
```

This returns a "List of 0" with 
Warning: XML content does not seem to be XML: ''

Let's start first with `RCurl::getURL`:  

```{r RCurl}
library(RCurl)
TPNWchars <- RCurl::getURL(TPNWurl)
str(TPNWchars)
length(TPNWchars)
nchar(TPNWchars)
```

This is a character vector of length 1 with, on 2020-08-08, 118644 characters.   

Now let's try `XML::readHTMLTable`:  

```{r}
library(XML)
TPNWtable <- XML::readHTMLTable(TPNWchars)
length(TPNWtable)
names(TPNWtable)
```

This is a "List of 18" with strange names.  What are their classes?  

```{r class}
library(purrr)
TPNWclasses <- map_chr(TPNWtable, class)
names(TPNWclasses) <- NULL
TPNWclasses
table(TPNWclasses)
```

That's interesting:  8 `data.frames` and 10 `NULL`s.  

What are the names corresponding to those? 

```{r names}
names(TPNWtable)[TPNWclasses=='data.frame']
names(TPNWtable)[TPNWclasses!='data.frame']
```

It looks like I should ignore the `names` -- and, of course, the `NULL`s:  

```{r TPNWtabs}
TPNWtabs <- TPNWtable[TPNWclasses=='data.frame']
```

What are the dimensions of these data.frames?  

```{r dims}
TPNWdimsL <- map(TPNWtabs, dim)
str(TPNWdims <- do.call(cbind, TPNWdimsL))
dimnames(TPNWdims) <- NULL
TPNWdims
```

I think the one I want is probably the first one:  

```{r TPNW1}
str(TPNW1 <- TPNWtabs[[1]])
```

Maybe not.  It may be 5 or 6;  the others are too small, unless it's a combination of several or not selected by `XML::readHTMLTable`:  

```{r TPNW5}
str(TPNW5 <- TPNWtabs[[5]])
```

That looks plausible. Let's also look at 6:

```{r TPNW6}
str(TPNW6 <- TPNWtabs[[6]])
```

`TPNW6` seems to be a much cleaner version of the data in `TPNW5`.  

Can we parse the dates?  

```{r dates}
Sign <- as.Date(TPNW6$Signature, 
      format='%d %b %Y')
A_AA_R_a <- as.Date(TPNW6[[3]], 
      format='%d %b %Y')
str(TPNW <- data.frame(Participant=TPNW6[[1]], 
    Sign=Sign, Acp_App_Rat_Acs=A_AA_R_a))
```

Select only those with dates of "Acceptance(A), Approval(AA), Ratification, Accession(a)":  

```{r selectA}
str(TPNWa <- TPNW[!is.na(TPNW[[3]]), ])
```

As of 2020-08-10 this has 44 observations, which matched the number of "Parties" to the TPNW.  

Sort: 

```{r order}
str(o <- do.call(order, TPNWa[c(3,1)]))
head(TPNWo <- TPNWa[o,])
tail(TPNWo,15)
```

## Time between?  

```{r dDate}
str(dDays <- difftime(tail(TPNWo[[3]], -1), 
        head(TPNWo[[3]], -1), units='days'))
quantile(dDays)
# number of times countries filed on the same day 
sum(dDays==0)
unique(TPNWo[which(dDays==0), 3])
```

What were the 0's?  

```{r sameDates}
sameD <- which(dDays==0)

str(sameD2 <- sort(unique(c(sameD, sameD+1))))
TPNWo[sameD2,]
length(unique(TPNWo[sameD2, 3]))
```

Fit exponential and gamma distributions: 

```{r fitdistr}
library(MASS)
(expo <- fitdistr(unclass(dDays), 'exponential'))
1/expo$estimate
```

Mean of `r round(1/expo$estimate, 2)` days.  An earlier manual computation gave roughly 25 days.  If these two numbers are close, the algorithm is probably still sensible.  

Considering the last censored observation gives a mean slightly larger than this number, but not much larger.  

What about using a gamma distribution?  

```{r gammaDist}
nRats <- nrow(TPNWo)

dD <- (as.numeric(dDays) + 2*.Machine$double.eps)
(gam <- fitdistr(dD, 'gamma',
    list(shape=1, rate=expo$estimate)))
#(gam <- fitdistr(unclass(dDays), 'gamma',
#    list(shape=1, rate=expo$estimate)))
# This fails for MASS::fitdistr 
library(fitdistrplus)
#fit.gamma <- fitdist(as.numeric(dDays), 
#        distr = "gamma", method = "mle")
fit.gamma <- fitdist(dD, 
        distr = "gamma", method = "mle")
summary(fit.gamma)
```

The mean of the gamma is shape/rate:  

```{r gamma2}
with(fit.gamma, estimate[1]/estimate[2])
```

So this is still roughly 25.  

The mean of a sum of `n` gamma distributions = `n EX`
with standard deviation $EX \sqrt n$.  If I use the gamma distribution, I'll get essentially the same answer as with the exponential distribution, but I'll have much greater difficulty understanding and explaining the shape parameter, which seems goofy to me.  There may be too many cases where several countries officially submitted their ratifications to the UN for the gamma estimation to be sensible.  

I will continue to assume an exponential distribution:  I don't have enough data nor a big enough need to worry more about this.    

I think I should multiply the standard deviation by 1.5 just to allow for overconfidence in the model.  ???

... or maybe not?  

```{r plot_dDays}
plot(dDays, type='b')
plot(1+dDays, type='b', log='y')
```

```{r dateRange}
#firstRat <- as.Date('20 September 2017', 
#                    format='%d %b %Y')
(firstRat <- TPNWo[1, 3])
library(lubridate)
str(Today <- today()+1)

(meanDaysBetwRats <- (difftime(Today, firstRat, 'days')
            / (nRats-1)))
if(nRats>=50){
  pred50 <- TPNWo[50, 3]
} else {
  pred50 <- (Today + 
      (50-nRats) * meanDaysBetwRats) 
}
print(pred50)
predEffective <- pred50 + 90
print(predEffective)
```

```{r sMean}
(sMean <- meanDaysBetwRats / sqrt(nRats-1))
(sRemaining <- sMean*sqrt(50-nRats))
as.numeric(sRemaining)
(dRemaining <- difftime(pred50, as.Date('2021-01-01'), 
                       "days" ))
(zRemaining <- dRemaining / as.numeric(sRemaining) )
pnorm(-zRemaining)

(z1Remaining <- (dRemaining-1) / as.numeric(sRemaining) )
pnorm(-z1Remaining)-pnorm(-zRemaining)
```

```{r mday}
(Aug <- (month(TPNWo[[3]])==8))
(Day <- day(TPNWo[[3]]))

TPNWo[(Hiro <- (Aug & (Day==6))),]
TPNWo[(Nag <- (Aug & (Day==9))), ]
```

## plot 

Stair step plot?

```{r plot}
xlim. <- c(TPNWo[3, 3], max(
      TPNWo[nRats, 3], as.Date('2021-01-28')))
ylim. <- c(0, max(50, nRats))

TPNWo$number <- 1:nRats
fit <- lm(number~Acp_App_Rat_Acs, TPNWo)

plot(TPNWo[[3]], 1:nRats, type='s', 
     lwd=2, xlab='', ylab='', main=
       'Number of ratifications of the TPNW', 
     ylim=ylim., xlim=xlim., cex.axis=1.5, 
     las=1)
     #, axes=FALSE)
#axis.Date(1, cex.axis=2)
#axis(2, cex.axis=2, las=1)
abline(coef=coef(fit), col='red', 
       lty=2, lwd=2)
abline(h=50, lty='dotted', col='green', 
       lwd=2)
if(nRats<50){
  segments(tail(TPNWo[, 3], 1), nRats, 
         pred50, 50, lty='dotted', 
         lwd=2, col='blue')
}
abline(v=pred50, lwd=2, col='blue', 
       lty='dotted')
text(pred50-60, 20, pred50, srt=90, 
     cex=2, col='blue')

if(!fda::CRAN()){
#pngFile <- paste0('TPNW', today())
  svgFile <- 'TPNW50thRatification.svg'
  svg(svgFile)
  par(mar=c(6, 5, 4, 2))
  plot(TPNWo[[3]], 1:nrow(TPNWo), type='s', 
     lwd=4, xlab='', ylab='', main=
       'Number of signatories of the TPNW', 
     ylim=ylim., xlim=xlim., cex.axis=3, 
     las=1, cex.main=2)
  abline(coef=coef(fit), col='red', 
       lty=2, lwd=4)
  abline(h=50, lty='dotted', col='green', 
       lwd=4)

  if(nRats<50){
    segments(tail(TPNWo[, 3], 1), nRats, 
         pred50, 50, lty='dotted', 
         lwd=4, col='blue')
  }
  abline(v=pred50, lwd=4, col='blue', 
       lty='dotted')
  text(pred50-50, 20, pred50, srt=90, 
     cex=3, col='blue')

  dev.off()
  getwd()
}
```
